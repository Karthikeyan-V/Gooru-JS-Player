var resourcePreview={init:function(A){EJS.ext=".template";var B=helper.getRequestParam();if(typeof (B.session_token)!="undefined"&&B.session_token!=""){USER.sessionToken=B.session_token}else{if(typeof (A)!="undefined"){USER.sessionToken=A.token}}$.ajaxSetup({data:{sessionToken:USER.sessionToken}});$("#gooru-resource-player-base-container").bind("activity.log",function(E,D,C){activityLog.init(C)});$(window).blur(function(){resourcePreview.resourcePlayerActivityStop()});USER.gooruUid=helper.getGooruUidWithToken(USER.sessionToken);resourcePreview.showResourcePreviewPopupBox(helper.getRequestParam())},renderResourceToggle:function(C){var E=C.id;var A=USER.sessionToken;var D=checkLocalHost();var B="";if(checkLocalHost()){B=HOME_URL+"/json/resource.json"}else{B=GOORU_REST_ENDPOINT+"/resource/"+E+"/play.json?sessionToken="+A}$.ajax({type:"GET",url:B,dataType:"json",success:function(F){resourcePreview.renderCollectionDetails(F,E,A)}})},renderCollectionDetails:function(C,D,A){var B="";if(checkLocalHost()){B=HOME_URL+"/json/collection.json"}else{B="http://qa.goorulearning.org/gooru-search/rest/search/scollection?sessionToken="+A+"&pageNum=1&pageSize=5&flt.resourceGooruOIds="+D+"&boostField.hasNoThumbnail=0"}$.ajax({type:"GET",url:B,dataType:"json",success:function(F){var G=F.searchResults;var E=new EJS({url:"/templates/resources/resourceMetaData.template"}).render({data:C,collection:G});$(".gooru-resource-player-meta-container").html(E);tipsyFn();$(".gooru-collection-img").click(function(){var H=$(this).attr("data-gooruoid");window.open(GOORU_PLAYER+"/#preview-play&id="+H,"_blank")})}})},showResourcePreview:function(previewValues){previewValues.useScribd=false;if(previewValues.documentId!=null&&previewValues.documentId!=""&&previewValues.documentKey!=null&&previewValues.documentKey!=""){previewValues.useScribd=true}previewValues.DOC_HOME=DOC_HOME;previewValues.DOC_CACHE=DOC_CACHE;previewValues.TOKEN=USER.sessionToken;var resourcePreviewHeader=new EJS({url:"/templates/resources/resourcePreviewHeader.template?buildId="+BUILD_TIME_STAMP}).render(previewValues);$("div#gooru-resource-player-base-container").css("height",($(window).height()-6));$("div#gooru-resource-player-base-container").html(resourcePreviewHeader);document.title=previewValues.title;var previewTemplate=new EJS({url:"/templates/resources/resourcePreview.template"}).render(previewValues);var previewHeight=$(window).height();with(previewValues){$("#meta-data-description").attr("content",publicMetaData);var signedBaseUrl=GOORU_REST_ENDPOINT+"/signed/resource/url/"+gooruOid;$("div#gooru-resource-player-container").html(previewTemplate);switch(type){case"video/youtube":var videoId=helper.getYoutubeVideoId(resourceUrl);resourcePlayers.youtubeVideo(videoId,startTime,"resourcePlayYoutubeplayer-"+gooruOid);break;case"animation/kmz":mtours.init((signedBaseUrl+"?file="+resourceUrl),"resourcePreviewGoogleEarthContainer");break;case"animation/swf":var fileExtension=resourceUrl.split(".").pop();if(fileExtension=="flv"){resourcePlayers.flvPlayer("../swf/flowplayer-3.2.11.swf","resourcePreviewFlashContainer")}else{resourcePlayers.animation((signedBaseUrl+"?file="+resourceUrl+"&sessionToken="+USER.sessionToken),"resourcePreviewFlashContainer")}break;case"textbook/scribd":if(useScribd){resourcePlayers.pdfReader(documentId,documentKey,startPPT,"resourcePreviewTextbookScribd")}break;case"assessment-question":resourcePlayers.questionResource(previewValues,"div.resourcePreviewBoxContentContainer");break}var activityLogId=generateGUID();$("div#gooru-resource-player-base-container").data("activity-log-id",activityLogId);$("div#gooru-resource-player-base-container").data("gooru-oid",gooruOid);activityLog.triggerActivityLog(activityLogId,"start",gooruOid,"resource-player",null,window.location,"resource-player-Start")}},showResourcePreviewPopupBox:function(D){var B=D.id;var C=D.resourceInstanceId;var A=GOORU_REST_ENDPOINT+"/resource/resourceSource/"+B+".json?";if(typeof (C)!="undefined"&&C!=null&&C!=""){A=GOORU_REST_ENDPOINT+"/collection/dummy/resourceInstance/"+C+".json"}$.ajax({type:"GET",url:A,dataType:"jsonp",success:function(E){resourcePreview.renderResourcePreview(E,D)},error:function(E){var F=new EJS({url:"/templates/resources/resourcePlayerInfo.template"}).render({message:"Resource Not Found, Please check the resource Id - "+D.id,reduceSize:0});$("div#gooru-resource-player-base-container").html(F)}})},renderResourcePreview:function(B,D){var C=D.resourceInstanceId;if(B.length==0){return }var A={resourceUrl:null,type:null,startTime:null,startPPT:null,stopPPT:null,filePath:null,title:null,description:null,resourceSource:null,gooruOid:null,isWebResource:null,resourceExtenstion:null,stopTime:null,resourceUserRating:B.social.contentUserRating,resourceRating:B.social.contentRating,resourceViews:null,isResourceAlreadyAdded:B.social.isContentAlreadySubscribed,documentKey:null,documentId:null,resourcestatus:{},thumbnail:null,resourceInstanceId:C,narrative:null,category:null,tags:null,standards:[],standardDescriptions:[],resourceLicense:{},siteName:null,publicMetaData:B.publicMetaData,questionType:null,answers:null,questionExplanation:null,questionHints:null,questionImageURL:null,assetURI:null,resourceFormatType:B.resourceFormat.value};A.gooruOid=D.id;if(C!=null&&typeof (C)!="undefined"&&C!=""){A.gooruOid=B.resource.id;A.resourceUrl=B.resource.nativeurl;A.type=B.resource.type;if(A.type==="video/youtube"){A.startPPT=(B.resource.instructornotes.start==null)?"":B.resource.instructornotes.start;A.stopPPT=(B.resource.instructornotes.stop==null)?"":B.resource.instructornotes.stop}else{A.startPPT=(B.resource.instructornotes.start==null||B.resource.instructornotes.start=="")?1:B.resource.instructornotes.start;A.stopPPT=(B.resource.instructornotes.stop==null)?"":B.resource.instructornotes.stop}preheightviewValues.assetURI=B.resource.assetURI;A.filePath=B.resource.assetURI+B.resource.resourcefolder;A.title=(B.resource.label==null)?"":B.resource.label;A.description=(B.resource.description==null)?"":B.resource.description;A.resourceSource=B.source;A.category=(B.resource.category==null)?"":B.resource.category;A.tags=(B.resource.tags==null)?"":B.resource.tags;A.standards=(typeof (B.resourceTaxonomyData.curriculum)=="undefined"||B.resourceTaxonomyData.curriculum.curriculumCode==null)?"":B.resourceTaxonomyData.curriculum.curriculumCode;A.standardDescriptions=(typeof (B.resourceTaxonomyData.curriculum)=="undefined"||B.resourceTaxonomyData.curriculum.curriculumDesc==null)?"":B.resourceTaxonomyData.curriculum.curriculumDesc;A.documentId=(B.resource.documentid==null)?"":B.resource.documentid;A.documentKey=(B.resource.documentkey==null)?"":B.resource.documentkey;A.resourcestatus.statusIsBroken=B.resource.resourcestatus.statusIsBroken;A.resourcestatus.statusIsFrameBreaker=B.resource.resourcestatus.statusIsFrameBreaker;A.thumbnail=B.resource.thumbnail;if(typeof B.resource.instructornotes!="undefined"&&B.resource.instructornotes!=null){A.resourceNarrative=B.resource.instructornotes.instruction}if(typeof B.resourceSiteName!="undefined"&&B.resourceSiteName!=null){A.siteName=B.resourceSiteName}}else{A.resourceUrl=B.url;A.type=B.resourceType.name;A.startPPT=(B.start==null||B.start=="")?1:B.start;A.stopPPT=(B.stop==null)?"":B.stop;A.filePath=B.assetURI+B.folder;A.thumbnail=B.thumbnail;A.title=(B.title==null)?"":B.title;A.category=(B.category==null)?"":B.category;A.tags=(B.tags==null)?"":B.tags,A.standards=(typeof (B.resourceTaxonomyData.curriculum)=="undefined"||B.resourceTaxonomyData.curriculum.curriculumCode==null)?"":B.resourceTaxonomyData.curriculum.curriculumCode,A.standardDescriptions=(typeof (B.resourceTaxonomyData.curriculum)=="undefined"||B.resourceTaxonomyData.curriculum.curriculumDesc==null)?"":B.resourceTaxonomyData.curriculum.curriculumDesc,A.description=(B.description==null)?"":B.description;A.resourceSource=B.resourceSource;A.resourcestatus.statusIsBroken=B.brokenStatus;A.resourcestatus.statusIsFrameBreaker=B.hasFrameBreaker;A.siteName=B.siteName;A.assetURI=B.assetURI}A.resourceLicense=B.license;if(typeof (A.startPPT)==="string"){A.startTime=helper.calculateTime(startPPT)}else{if(typeof (A.startPPT)==="number"){A.startTime=A.startPPT}}if(typeof (A.stopPPT)==="string"){A.stopTime=helper.calculateTime(A.stopPPT)}else{if(typeof (A.stopPPT)==="number"){A.stopTime=A.stopPPT}}A.resourceViews=Number(B.resourceViews)+1;A.isWebResource=helper.isWebResource(A.resourceUrl,A.type);A.resourceExtenstion=helper.getResourceFileExtenstion(A.resourceUrl);if(A.type=="assessment-question"){A.questionType=B.typeName;A.answers=B.quizQuestion.answers;A.questionExplanation=B.explanation;A.questionHints=B.quizQuestion.hints;A.questionImageURL=resourcePreview.checkImageURLStatus(B.thumbnails.url)}resourcePreview.showResourcePreview(A);resourcePreview.renderResourceToggle(D);resourcePreview.showResourceCollections(A.gooruOid);helper.updateResourceViews(A.gooruOid,A.resourceViews);helper.previewToolTip(".resourceBottomPreviewTooltip","bottom");if(A.resourceLicense!=null&&typeof (A.resourceLicense.name)!="undefined"&&A.resourceLicense.name!="Other"&&A.resourceLicense.code!=""){helper.previewToolTip(".resourcePreviewTooltipLicense","bottom")}helper.previewToolTip(".resourceBottomPreviewTooltipOER","bottom");if(A.standards.length>3){helper.previewToolTip(".standardExtraCount","bottom")}resourcePreview.handleResourcePreviewEvents();resourcePreview.sendResourceDataForEventLogging(A)},sendResourceDataForEventLogging:function(previewValues){var eventLoggingData=helper.getEventDataObject();var resourceStartTime=helper.getTimeInMilliSecond();with(previewValues){var resourceSessionId=helper.getSessionIdForEvent(gooruOid,eventLoggingData.sessionToken);eventLoggingData.contentGooruId=gooruOid;eventLoggingData.activityType="start";eventLoggingData.eventId=generateGUID().toUpperCase();eventLoggingData.startTime=resourceStartTime;eventLoggingData.stopTime=resourceStartTime;eventLoggingData.eventName="resource.play";eventLoggingData.sessionId=(resourceSessionId.length>0)?resourceSessionId:generateGUID();eventLoggingData.questionType=(questionType!=null)?questionType:"RES";eventLoggingData.resourceType=(type=="assessment-question")?"question":"resource";activityLog.generateEventLogData(eventLoggingData)}setInterval(function(){resourcePreview.triggerStopEventLoggingForResource(eventLoggingData)},5000);resourcePreview.submitQuestionEventData(eventLoggingData)},triggerStopEventLoggingForResource:function(A){var B=helper.getTimeInMilliSecond();A.activityType="stop";A.stopTime=B;A.totalTimeSpent=5000;activityLog.generateEventLogData(A)},submitQuestionEventData:function(C){var E="";var B="";var F=0;var D=0;var A="";var G="";C.hintTimeStamp="";$("input#gooru-question-explanation-button").click(function(){C.questionExplanationTimestamp=helper.getTimeInMilliSecond()});$("input#gooru-question-hint-button").click(function(){C.hintTimeStamp+='"'+$("div.gooru-question-hint-container-"+D).data("hint-id")+'":'+helper.getTimeInMilliSecond()+",";D++});$("input.gooru-answer-container").click(function(){var O=$(this).data("question-type");var K=helper.getTimeInMilliSecond();C.activityType="stop";C.totalTimeSpent=K-C.stopTime;C.stopTime=K;if(O=="T/F"||O=="MC"){F++;E+=","+helper.isAttemptAnswerCorrect();B+=","+$('input[name="gooru-mcq"]:checked').data("answer-sequence");G+='"attempt'+F+'":[{"text":"'+helper.encodeTextForQuestionResource($("div.multiple-choice-answer-text-"+$('input[name="gooru-mcq"]:checked').data("answer-sequence"))[0].innerHTML)+'","status":"'+helper.isAttemptAnswerCorrect()+'","order":"'+$('input[name="gooru-mcq"]:checked').data("answer-sequence")+'","skip":false,"answerId":'+$('input[name="gooru-mcq"]:checked').data("answer-id")+',"timeStamp":'+K+"}],";A+='"'+$('input[name="gooru-mcq"]:checked').data("answer-id")+'":'+K+",";C.questionAttemptSequence=B;C.questionAttemptData=E;C.answerTimestamp=A;C.answerObject=G}if(O=="FIB"){var R=$("input.fib-answer");var J=1;var L="";for(var H=0;R.length>H;H++){F++;if($(R[H]).css("background-color")=="rgb(254, 232, 199)"){J=0}B=","+F;L+="["+$(R[H]).val()+"],";A+='"'+$(R[H]).data("answer-fib-id")+'":'+K+",";var I=($(R[H]).val().trim().length>0)?false:true;G+='{"text":"'+helper.encodeTextForQuestionResource($(R[H]).val())+'","status":"'+J+'","order":"'+F+'","skip":'+I+',"answerId":'+$(R[H]).data("answer-fib-id")+',"timeStamp":'+K+"},"}C.answerText=helper.encodeTextForQuestionResource(L);C.questionAttemptData=","+J;C.questionAttemptSequence=B;C.answerTimestamp=A;C.answerObject='"attempt1":['+G.substring(0,G.length-1)+"],"}if(O=="MA"){var P=$("input.gooru-ma-radio-button");F++;var M="";var S="";var N=0;E+=","+helper.isAttemptAnswerCorrect();for(var T=0;P.length>T;T++){if($(P[T]).is(":checked")){N++;S+="["+$(P[T]).data("radio-position")+"],";A+='"'+$(P[T]).attr("name")+'":'+K+",";var Q=($(P[T]).val()==$(P[T]).data("mc-is-correct").toString())?1:0;M+='{"text":"'+$(P[T]).data("radio-position")+'","status":"'+Q+'","order":"'+N+'","skip":false,"answerId":'+$(P[T]).attr("name")+',"timeStamp":'+K+"},"}}C.answerText=S;C.answerTimestamp=A;C.answerObject='"attempt1":['+M.substring(0,M.length-1)+"],";C.questionAttemptSequence=",1";C.questionAttemptData=E}if(O=="OE"){C.answerText=helper.encodeTextForQuestionResource($("textarea#gooru-oe-answer-submit").val())+",";C.questionAttemptData=",";C.answerObject='"attempt1":[{"text":"'+helper.encodeTextForQuestionResource($("textarea#gooru-oe-answer-submit").val())+'","status":"1","order":"","skip":false,"answerId":'+0+',"timeStamp":'+K+"}]";helper.sendSaveEventForOEQuestionResource(C.contentGooruId,C.answerText,C.questionAttemptData,C.answerObject,"resource",K,C.sessionId)}activityLog.generateEventLogData(C)})},showResourceCollections:function(A){$.ajax({type:"GET",url:GOORU_REST_ENDPOINT+"/search/scollection?&pageNum=1&pageSize=5&flt.resourceGooruOIds="+A+"&boostField.hasNoThumbnail=0",dataType:"jsonp",success:function(B){var C=new EJS({url:"/templates/resources/resourceCollections.template"}).render({resourceCollection:B,HOME_URL:HOME_URL,TOKEN:USER.sessionToken});if(B.searchResults.length>0&&typeof (B.searchResults)!="undefined"){$("div#gooru-resource-player-learn-more-container").html(C);$("div#gooru-resource-player-learn-more-grey").hide();$("div#gooru-resource-player-learn-more").show();$("div.learn-more-image-container").mouseenter(function(){$(this).find("div.gooru-resource-player-learn-more-content").show()});$("div.learn-more-image-container").mouseleave(function(){$(this).find("div.gooru-resource-player-learn-more-content").hide()})}else{$("div#gooru-resource-player-learn-more-grey").show();$("div#gooru-resource-player-learn-more").hide();var D=helper.getRequestParam();if(D.state=="learnMore"){$("div#gooru-resource-player-about").trigger("click")}}},error:function(B,D,C){}})},handleResourcePreviewEvents:function(){$("div#gooru-resource-player-about").click(function(){$("span.resourcePreviewHeaderNavigationArrowLearnMore, span.resourcePreviewHeaderNavigationArrowShare, div#gooru-resource-player-share-container, div#gooru-resource-player-learn-more-container").hide();$("div#gooru-resource-player-header-container").find(".gooru-resource-player-menu-share-selected").removeClass("gooru-resource-player-menu-share-selected");$("div#gooru-resource-player-header-container").find(".gooru-resource-player-menu-learn-more-selected").removeClass("gooru-resource-player-menu-learn-more-selected");$("div#gooru-resource-player-about-header").toggleClass("gooru-resource-player-menu-about-selected");$("span.resourcePreviewHeaderNavigationArrowAbout, div#gooru-resource-player-about-container").slideToggle("slow",function(){A()})});$("div#gooru-resource-player-learn-more").click(function(){$("span.resourcePreviewHeaderNavigationArrowAbout, span.resourcePreviewHeaderNavigationArrowShare, div#gooru-resource-player-about-container ,div#gooru-resource-player-share-container").hide();$("div#gooru-resource-player-header-container").find(".gooru-resource-player-menu-share-selected").removeClass("gooru-resource-player-menu-share-selected");$("div#gooru-resource-player-header-container").find(".gooru-resource-player-menu-about-selected").removeClass("gooru-resource-player-menu-about-selected");$("div#gooru-resource-player-learn-more-header").toggleClass("gooru-resource-player-menu-learn-more-selected");$("div#gooru-resource-player-learn-more-container").slideToggle("slow",function(){A()});$("span.resourcePreviewHeaderNavigationArrowLearnMore").is(":visible")?$("span.resourcePreviewHeaderNavigationArrowLearnMore").hide():$("span.resourcePreviewHeaderNavigationArrowLearnMore").css("display","block")});var B=helper.getRequestParam();if(B.state=="resourceView"){$("div#gooru-resource-player-about-container, span.resourcePreviewHeaderNavigationArrowAbout").hide();A()}if(B.state=="learnMore"){$("div#gooru-resource-player-learn-more").trigger("click")}function A(){var C=$(window).height();if($("div.gooru-resource-player-menu-container").is(":visible")){$(".gooru-resource-player-preview-container, div.resourcePreviewBoxContentContainer, div.gooru-question-play-container").css("height",(C-162))}else{$(".gooru-resource-player-preview-container, div.resourcePreviewBoxContentContainer, div.gooru-question-play-container").css("height",(C-47))}}},resourcePlayerActivityStop:function(){var A=$("div#gooru-resource-player-base-container").data("activity-log-id");var B=$("div#gooru-resource-player-base-container").data("gooru-oid");activityLog.triggerActivityLog(A,"stop",B,"resource-player",null,window.location,"resource-player-stop")},checkImageURLStatus:function(A){var B="";$.ajax({async:false,type:"GET",url:A,complete:function(C,D){B=(C.status==200)?A:null}});return B}};function onYouTubePlayerReady(A){var E=document.getElementById(A);var F=A.split("youtubeMovie-resourcePlayYoutubeplayer-")[1];var D=$("div#resourcePlayYoutubeplayer-"+F).data("videostop");var B=$("div#resourcePlayYoutubeplayer-"+F).data("fromprerender");if(E!=null){var C=E.getDuration();if(Number(D)>=Number(C)||Number(D)<=0){D=C-1}resourcePlayers.playVideo(E,D);E.addEventListener("onStateChange","onYouTubeStateChange")}}function onYouTubeStateChange(C){if(C===2||C===0){resourcePreview.resourcePlayerActivityStop()}if(C!=2){var A=$("div.currentlyPlayingYoutubeVideoResource").data("playerid");if(typeof (A)!="undefined"){var B=$("div.currentlyPlayingYoutubeVideoResource").data("videostop");var D=document.getElementById("youtubeMovie-resourcePlayYoutubeplayer-"+A);resourcePlayers.triggerStopVideo(D,B)}}}$(document).ready(function(){helper.userSignin({onComplete:resourcePreview.init})});function checkLocalHost(){if(window.location.href.indexOf("anand.goorulearning.org")>-1){return true}else{return false}}function tipsyFn(){$(".dashboard-course-num-tipsy").tipsy({theme:"white",opacity:100,gravity:"n",html:true,title:function(D){var B=$(this).attr("original-title");var E=B.split(",");var C='<ul style="width:auto;padding-right:20px;text-align:left;">';for(var A=2;A<E.length;A++){C+="<li>"+E[A]+"</li>"}C+="</ul>";return C}});$(".dashboard-description-tipsy").tipsy({theme:"white",opacity:100,gravity:"n",html:true,title:function(C){var A=$(this).attr("original-title");var B='<div style="width:200px;margin-top:5px;text-align:left;">';B+="<p>"+A+"</p>";B+="</div>";return B}})};